name: ðŸ§¬ Publish Version

on:
  workflow_dispatch:
    inputs:
      action:
        description: Version to bump to
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
          - premajor
          - preminor
          - prepatch
      push:
        description: Push changes and create release
        default: false
        type: boolean

jobs:

  test:
    name: Test
    uses: ./.github/workflows/test.yml
    secrets: inherit

  version:
    name: Version
    needs: test
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.bump.outputs.tag }}
      version: ${{ steps.bump.outputs.version }}
      release-notes: ${{ steps.bump.outputs.release-notes }}
    steps:

    - name: Validate Branch
      if: inputs.push
      run: |
        if [[ "$GITHUB_REF_NAME" != "main" ]]; then
          echo "Error: Releases can only be pushed from main. Current branch: $GITHUB_REF_NAME"
          exit 1
        fi

    - name: Create GitHub App Token
      id: app-token
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ vars.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_KEY }}

    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ steps.app-token.outputs.token }}

    - name: Bump Version
      id: bump
      uses: duplocloud/version-bump@main
      with:
        version: ${{ inputs.action }}
        push: ${{ inputs.push }}
        token: ${{ steps.app-token.outputs.token }}

  image:
    name: Publish Image
    needs: version
    uses: ./.github/workflows/image.yml
    with:
      tag: ${{ inputs.push && needs.version.outputs.tag || '' }}
      push: ${{ inputs.push }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || '' }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD || '' }}

  package:
    name: Publish Package
    needs: version
    uses: ./.github/workflows/package.yml
    secrets: inherit
    with:
      tag: ${{ inputs.push && needs.version.outputs.tag || '' }}

  release:
    name: Release
    needs:
    - version
    - image
    - package
    if: inputs.push
    runs-on: ubuntu-latest
    steps:

    - name: Create GitHub App Token
      id: app-token
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ vars.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_KEY }}

    - name: Registry Info
      id: registry
      env:
        TAG: ${{ needs.version.outputs.tag }}
      run: |
        URL="https://hub.docker.com/r/duplocloud/mcp"
        BADGE="[![Docker Hub](https://img.shields.io/badge/Docker-Hub-blue?style=flat-square&logo=docker)](${URL})"
        echo "url=${URL}" >> "$GITHUB_OUTPUT"
        echo "image=duplocloud/mcp:${TAG}" >> "$GITHUB_OUTPUT"
        echo "badge=${BADGE}" >> "$GITHUB_OUTPUT"

    - name: Download Package Artifact
      uses: actions/download-artifact@v6
      with:
        name: ${{ needs.package.outputs.package }}
        path: dist

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ steps.app-token.outputs.token }}
        name: ${{ needs.version.outputs.tag }}
        tag_name: ${{ needs.version.outputs.tag }}
        prerelease: ${{ contains(needs.version.outputs.tag, '-') }}
        files: dist/*.tar.gz
        body: |
          [![Publish](${{ github.server_url }}/${{ github.repository }}/actions/workflows/publish.yml/badge.svg)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ${{ steps.registry.outputs.badge }}

          ${{ needs.version.outputs.release-notes }}

          ## Docker Image

          ```
          docker pull duplocloud/mcp:${{ needs.version.outputs.tag }}
          ```

          Docker Hub: ${{ steps.registry.outputs.url }}

    - name: Summary
      run: |
        cat <<EOF > "$GITHUB_STEP_SUMMARY"
        ## Publish Complete

        **Tag**: ${{ needs.version.outputs.tag }}
        **Image**: ${{ steps.registry.outputs.image }}

        ### Release Notes
        ${{ needs.version.outputs.release-notes }}
        EOF
