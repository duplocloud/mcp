name: ðŸŽº Publish Image

on:
  workflow_dispatch: {}
  workflow_call:
    inputs:
      push:
        description: Push the image to the registry
        required: false
        default: true
        type: boolean
      tag:
        description: The git tag to build on
        required: false
        type: string
    outputs:
      image:
        description: The URI of the image
        value: ${{ jobs.build_image.outputs.image }}
    secrets:
      DOCKER_USERNAME:
        description: Docker username
        required: false
      DOCKER_PASSWORD:
        description: Docker password
        required: false

jobs:
  build_image:
    name: Image
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build_image.outputs.uri }}
    environment:
      name: ${{ inputs.push && 'dockerhub' || '' }}
      url: ${{ inputs.push && 'https://hub.docker.com/r/duplocloud/mcp' || '' }}
    env:
      PY_VERSION: "3.13"
    steps:

    - name: Setup
      id: setup
      uses: .github/actions/setup@main
      with:
        ref: ${{ inputs.tag }}
        app-id: ${{ vars.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_KEY }}
        install: false

    - name: Build and Push Docker Image
      id: build_image
      uses: duplocloud/actions/build-image@main
      env:
        GIT_TAG: ${{ inputs.tag }}
      with:
        type: bake
        target: mcp
        repo: duplocloud/mcp
        push: ${{ inputs.push }}
        docker-username: ${{ secrets.DOCKER_USERNAME }}
        docker-password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker Hub Description
      uses: peter-evans/dockerhub-description@v4
      if: inputs.push
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        repository: ${{ github.repository }}
